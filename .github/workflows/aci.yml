name: afterCI

on:
  # workflow_run:
  #     workflows: ["Sillot CI/CD"]
  #     types:
  #       - completed
  workflow_dispatch:
  release:
    types: [released]
    # https://docs.github.com/zh/actions/using-workflows/events-that-trigger-workflows#release


jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Required Packages
      run: |
          sudo apt-get update && sudo apt-get install -y openssl
          curl -Lo shasum https://raw.githubusercontent.com/apple/darwin-tools/master/shasum
          chmod +x shasum

    - name: Get Latest Release Assets
      id: latest_release
      uses: actions/github-script@v6
      with:
          result-encoding: string
          retries: 3
          script: |
            const { data } = await github.repos.getLatestRelease({
               owner: context.repo.owner,
               repo: context.repo.repo,
            });
            data = JSON.stringify(data);
            data.assets.forEach(e=>{
            console.log(e.browser_download_url);
            github.request(e.browser_download_url).then(r=>{console.log(r)});
            });
            return data.assets
      continue-on-error: false

    - name: Generate Hash for Assets
      id: generate_hash
      run: |
          cd ${{ github.workspace }}/assets
          for file in $(find . -type f -not -path '*/\.*'); do
            sha=$(../shasum -a 256 $file | awk '{print $1}')
            echo "$sha  $file" >> assets_hash.txt
          done
      continue-on-error: false

    - name: Upload Hash File to Release Asset
      uses: actions/upload-release-asset@v1
      with:
          upload_url: ${{ steps.latest_release.outputs.upload_url }}
          asset_path: ./assets/assets_hash.txt
          asset_name: assets_hash.txt
          asset_content_type: text/plain